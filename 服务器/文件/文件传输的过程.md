# 文件传输的过程



## 1.文件传输的流程

如果一台服务器向另一台服务器传输磁盘的文件数据时，需要经历的过程是什么？

![img](H:\学习\后端\java\基本概念\io模型\图片\webp)

1. 应用程序中调用`read()` 方法，这里会涉及到一次上下文切换（用户态->内核态），底层采用DMA（direct memory access）读取磁盘的文件，并把内容存储到内核地址空间的读取缓存区。
2. 由于应用程序无法读取内核地址空间的数据，如果应用程序要操作这些数据，必须把这些内容从读取缓冲区拷贝到用户缓冲区。这个时候，`read()` 调用返回，且引发一次上下文切换（内核态->用户态），现在数据已经被拷贝到了用户地址空间缓冲区，这时，如果有需要，应用程序可以操作修改这些内容。
3. 我们最终目的是把这个文件内容通过Socket传到另一个服务中，调用Socket的`send()`方法，这里又涉及到一次上下文切换（用户态->内核态），同时，文件内容被进行第三次拷贝，被再次拷贝到内核地址空间缓冲区，但是这次的缓冲区与目标套接字相关联，与读取缓冲区没有半点关系。
4. `send()`调用返回，引发第四次的上下文切换，同时进行第四次的数据拷贝，通过DMA把数据从目标套接字相关的缓存区传到协议引擎进行发送。

传统发送文件的过程代码：

```java
file.read();
socket.send();
```

## 2.实现零拷贝的原理

1.如果不需要修改，取消切换到用户态

![img](H:\学习\后端\java\基本概念\io模型\图片\webp1)

这种实现，可以有以下几点改进：

- 上下文切换的次数从四次减少到了两次
- 数据拷贝次数从四次减少到了三次（其中DMA copy 2次，CPU copy 1次）

```java
public void transferTo(long position, long count, WritableByteChannel target);
```

2.添加描述符

![img](H:\学习\后端\java\基本概念\io模型\图片\webp2)

第一步，transferTo() 方法引发 DMA 将文件内容拷贝到内核读取缓冲区。

第二步，把包含数据位置和长度信息的描述符追加到套接字缓冲区，避免了内容整体的拷贝，DMA 引擎直接把数据从内核缓冲区传到协议引擎，从而消除了最后一次 CPU参与的拷贝动作。